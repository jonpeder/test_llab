{% extends "base.html" %}
{% block content %}


<!-- SIDEBAR -->
<!-- A collapsible sidebar hovering over the left side of the page -->
<div class="collapse width" id="sidebar"
  style="position: fixed;top: 1;left: 0;height: 100%;width: 500px;z-index: 1000;max-height: 80vh;overflow-y: auto;padding: 5px;margin: 0px;border: 0px;">
  <div class="card">
    <!-- FILTERS -->
    <div class="card">
      <div class="card-header">
        <a class="btn" data-bs-toggle="collapse" href="#collapseFilters">
          Filters
        </a>
      </div>
      <!-- Filter collapsible -->
      <div id="collapseFilters" class="collapse">
        <div class="card-body">
          <!-- Filter form -->
          <form action="/" method=post>
            <!-- Identification filters -->
            Identification filters
            <div class="container-fluid">
              <!-- 1. Taxa -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#taxa"
                  aria-expanded="true" aria-controls="taxa">
                  Taxa
                </button>
              </div>
              <div class="collapse" id="taxa">
                    <div class="mb-1">
                        <select class="form-control selectpicker" id="taxon_name" name="taxon_name"
                            data-live-search="true">
                            <option value=""></option>
                            {% for name in dropdown_names %}
                            {% set concat_name = name ~ ' [' ~ dropdown_ranks[loop.index0] ~ ']' %}
                            <option value="{{ concat_name }}" {% if filters.taxon_name==concat_name%}selected{% endif %}>
                                {{ concat_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
              <!-- 2. Rank -->
                <div class="mb-1">
                    <button class="btn btn-link" type="button" data-bs-toggle="collapse"
                        data-bs-target="#rank" aria-expanded="false" aria-controls="rank">
                        Rank
                    </button>
                </div>
                <div class="collapse" id="rank">
                    <div class="mb-1">
                        <select class="form-control selectpicker" id="taxon_rank" name="taxon_rank">
                            <option value=""></option>
                            {% for rank in ranks %}
                            <option value="{{ rank }}" {% if filters.taxon_rank==rank %}selected{% endif %}>{{
                                rank }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
              <!-- 3. sex -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#sex"
                  aria-expanded="false" aria-controls="sex">
                  Sex
                </button>
              </div>
              <div class="collapse" id="sex">
                <div class="mb-1">
                  <select class="form-control selectpicker" id="sex" name="sex">
                    <option value=""></option>
                    <option value="male"{% if filters.sex=="male" %}selected{% endif %}>male</option>
                    <option value="female"{% if filters.sex=="female" %}selected{% endif %}>female</option>
                  </select>
                </div>
              </div>
            </div>
            <!-- Collecting event filters -->
            Collecting event filters
            <!-- Polygon eventIDs -->
            <input type="hidden" id="polygon_event_ids" name="polygon_event_ids" value="">
            <div class="container-fluid">
              <!-- 4. Collecting event ID -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#event_id"
                  aria-expanded="false" aria-controls="Locality">
                  Collecting event ID
                </button>
              </div>
              <div class="collapse" id="event_id">
                <select class="form-control selectpicker" id="eventID" name="eventID" data-live-search="true">
                  <option value=""></option>
                  {% for event in collecting_events %}
                  <option value="{{ event.eventID }}" {% if filters.rank==event.eventID %}selected{% endif %}>{{event.eventID }}</option>
                  {% endfor %}
                </select>
              </div>
              <!-- 5. Locality -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#Locality"
                  aria-expanded="false" aria-controls="Locality">
                  Locality
                </button>
              </div>
              <div class="collapse" id="Locality">
                <!-- 5.1 Country -->
                <div class="mb-1">
                  Country
                  <select class="form-control selectpicker" id="country" name="country" data-live-search="true">
                    <option value=""></option>
                    {% for country in countries %}
                    <option value="{{ country }}" {% if filters.country==country %}selected{% endif %}>{{ country }}</option>
                    {% endfor %}
                  </select>
                </div>
                <!-- 5.2 County -->
                <div class="mb-1">
                  County
                  <select class="form-control selectpicker" id="county" name="county" data-live-search="true">
                    <option value=""></option>
                    {% for county in counties %}
                    <option value="{{ county }}" {% if filters.county==county %}selected{% endif %}>{{ county }}</option>
                    {% endfor %}
                  </select>
                </div>
                <!-- 5.3 Municipality -->
                <div class="mb-1">
                  Municipality
                  <select class="form-control selectpicker" id="municipality" name="municipality"
                    data-live-search="true">
                    <option value=""></option>
                    {% for municipality in municipalities %}
                    <option value="{{ municipality }}" {% if filters.municipality==municipality %}selected{% endif %}>{{ municipality }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <!-- 6. Habitat -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#Habitat"
                  aria-expanded="false" aria-controls="Habitat">
                  Habitat
                </button>
              </div>
              <div class="collapse" id="Habitat">
                <div class="mb-1">
                  <select class="form-control selectpicker" id="eunis" name="eunis" data-live-search="true">
                    <option selected value=""></option>
                    {% for level2 in habitat_level2 %}
                    <optgroup label="{{ level2 }}">
                      {% for habitat in habitats %}
                      {% if habitat.level2 == level2 %}
                      <option value="{{ habitat.eunisCode }}">{{ habitat.habitatName }} ({{
                        habitat.eunisCode }})</option>
                      {% endif %}
                      {% endfor %}
                    </optgroup>
                    {% endfor %}
                  </select>
                  <br>
                </div>
              </div>
              <!-- 7. date -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#date"
                  aria-expanded="false" aria-controls="date">
                  Date
                </button>
              </div>
              <div class="collapse" id="date">
                <div class="mb-1">
                  <input type="date" class="form-control" id="date_from" name="date_from" value="{{ filters.date_from }}" placeholder="From">
                </div>
                <div class="mb-1">
                  <input type="date" class="form-control" id="date_to" name="date_to" value="{{ filters.date_to }}" placeholder="To">
                </div>
              </div>
              <!-- 8. method -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#method"
                  aria-expanded="false" aria-controls="method">
                  Method
                </button>
              </div>
              <div class="collapse" id="method">
                <div class="mb-1">
                  <select class="form-control selectpicker" id="method" name="method">
                    <option value=""></option>
                    {% for method in methods %}
                    <option value="{{ method }}" {% if filters.method==method %}selected{% endif %}>{{ method }}</option>
                    {% endfor %}

                  </select>
                </div>
              </div>
            </div>
            <!-- 9. Specimen IDs, Unit IDs and drawer-names. QR-codes are decoded and inserted here -->
            QR-code filters
            <div class="container-fluid">
              <!-- 9.1 Specimen labels -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#SpecimenIDs"
                  aria-expanded="false" aria-controls="SpecimenIDs">
                  Specimen IDs
                </button>
              </div>
              <div class="collapse" id="SpecimenIDs">
                <div class="mb-3">
                  <textarea type="text" class="form-control" id="occurrence_ids" name="occurrence_ids" value="{{ filters.occurrence_ids }}"
                    placeholder="Insert decoded QR-codes here!"></textarea>
                  <small id="qr-dataHelp" class="form-text text-muted">Decoded QR-codes from
                    specimen-labels</small>
                </div>
              </div>
              <!-- 9.2 Unit IDs -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#UnitIDs"
                  aria-expanded="false" aria-controls="UnitIDs">
                  Unit IDs
                </button>
              </div>
              <div class="collapse" id="UnitIDs">
                <div class="mb-3">
                  <textarea type="text" class="form-control" id="unit_ids" name="unit_ids" value="{{ filters.unit_ids }}"
                    placeholder="Insert decoded QR-codes here!"></textarea>
                  <small id="qr-dataHelp" class="form-text text-muted">Decoded QR-codes from
                    taxon-labels</small>
                </div>
              </div>
              <!-- 9.3 Drawer IDs -->
              <div class="mb-1">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#DrawerName"
                  aria-expanded="false" aria-controls="DrawerName">
                  Drawer name
                </button>
              </div>
              <div class="collapse" id="DrawerName">
                <div class="mb-3">
                  <select class="form-control selectpicker" id="drawer_name" name="drawer_name" data-live-search="true">
                    <option value=""></option>
                    {% for drawer in drawers %}
                    <option value="{{ drawer }}" {% if filters.drawer==drawer %}selected{% endif %}>{{ drawer }}</option>
                    {% endfor %}
                  </select>
                  <small id="qr-dataHelp" class="form-text text-muted">Name of the drawer</small>
                </div>
              </div>
            </div>
            <!-- 10. Dataset filter -->
            <div class="mb-1">
              <a href="#collapseExample" role="button" data-bs-toggle="collapse" data-bs-target="#DatasetFilter"
                aria-expanded="false" aria-controls="DatasetFilter">
                Dataset
              </a>
            </div>
            <div class="collapse" id="DatasetFilter">
              <div class="mb-1">
                <select class="form-control selectpicker" id="datasetfilter" name="datasetfilter">
                  <option value=""></option>
                  {% for dataset in datasets %}
                  <option value="{{ dataset.datasetName }}" {% if filters.datasetName==dataset.datasetName %}selected{% endif %}>{{ dataset.datasetName }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <p></p>
            <!-- buttons -->
            <div class="d-inline mb-3">
              <!-- Submit button -->
              <button type="submit" class="btn btn-success" name="specimen_filter"
                value="specimen_filter">Filter</button>
              <!-- Clear filter button -->
              <button type="submit" class="btn btn-secondary" name="clear_filter" value="clear_filter">Clear
                filter</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- DATASETS -->
    <div class="card">
      <div class="card-header">
        <a class="btn" data-bs-toggle="collapse" href="#collapseDatasets">
          Datasets
        </a>
      </div>
      <!-- Dataset collapsible -->
      <div id="collapseDatasets" class="collapse">
        <div class="card-body">
          Alter a dataset by adding or removing selected specimens
          <br>
          <br>
          <div class="mb-1">
            <select class="form-control" id="dataset" name="dataset">
              {% for dataset in datasets %}
              <option value="{{ dataset.datasetName }}">{{ dataset.datasetName }}</option>
              {% endfor %}
            </select>
          </div>
          <small id="dataset-dataHelp" class="form-text text-muted">Select dataset to be
            altered</small>
          <br>
          <br>
          <!-- Buttons to add or remove selected specimens from dataset -->
          <div class="d-inline mb-3">
            <button type="submit" class="btn btn-success" id="add_to_dataset" value="add_to_dataset">Add
              to dataset</button>
            <button type="submit" class="btn btn-secondary" id="remove_from_dataset" value="remove_from_dataset">Remove
              from dataset</button>
          </div>
          <br>
          <br>
          <!-- Dismissible Alert -->
          <div id="responseMessage" class="alert alert-warning fade hide" role="alert">
            <span id="messageContent"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- EXPORT -->
    <div class="card-header">
      <a class="btn" data-bs-toggle="collapse" href="#collapseExport">
        Export
      </a>
    </div>
    <!-- Export collapsible -->
    <div id="collapseExport" class="collapse">
      <div class="card-body">
        <!-- Export collecting-events table -->
        <div class="mb-1">
          <button type="button" class="btn btn-secondary" id="exportEvents">Collecting-events table</button>
        </div>
        <div class="mb-1">
          <small id="exportEvents-dataHelp" class="form-text text-muted">Export collecting-events in query</small>
        </div>
        <!-- Export faunistic report -->
        <div class="mb-1">
          <a class="btn btn-secondary" href="#" target="_blank" id="exportFaunistic">
            Faunistic report
          </a>
        </div>
        <div class="mb-1">
          <small id="exportFaunistic-dataHelp" class="form-text text-muted">Export faunistic report from selected
            specimens</small>
        </div>
        <!-- Export DNA-barcodes -->
        <div class="mb-1">
          <a class="btn btn-secondary" href="#" target="_blank" id="exportDnaBarcodes">
            DNA barcodes
          </a>
        </div>
        <div class="mb-1">
          <small id="exportDnaBarcodes-dataHelp" class="form-text text-muted">Export fasta formatted DNA barcodes from
            selected specimens</small>
        </div>
        <!-- Export table formatted for GBIF-import -->
        <div class="mb-1">
          <a class="btn btn-secondary" href="#" target="_blank" id="exportGBIF">
            GBIF
          </a>
        </div>
        <div class="mb-1">
          <small id="exportGBIF-dataHelp" class="form-text text-muted">Export table formatted for GBIF-import</small>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- HOVERING TOGGLE BUTTONS -->
<div class="fixed-bottom-left" style="position: fixed;left: 10px;bottom: 10px;z-index: 1030;">
  <!-- Button to toggle the sidebar -->
  <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar">Tools</button>
  <!-- Buttons to toggle between table, map and stat view -->
  <button type="button" class="btn btn-secondary"
    onclick="document.getElementById('mapContainer').style.display = 'block'; document.getElementById('statContainer').style.display = 'none'; document.getElementById('tableContainer').style.display = 'none';">Map</button>
  <button type="button" class="btn btn-secondary"
    onclick="document.getElementById('mapContainer').style.display = 'none'; document.getElementById('statContainer').style.display = 'none'; document.getElementById('tableContainer').style.display = 'block';">Table</button>
  <button type="button" class="btn btn-secondary"
    onclick="document.getElementById('mapContainer').style.display = 'none'; document.getElementById('statContainer').style.display = 'block'; document.getElementById('tableContainer').style.display = 'none';">Metrics</button>
</div>


<!-- MAP -->
<div class="container-fluid" id="mapContainer">
  <div id="map" style="height: 600px;z-index: 10;">
    <!-- leaflet script -->
    <script type="text/javascript">
      // The first parameters are the coordinates of the center of the map, the second parameter is the zoom level
      var map = L.map('map', { fullscreenControl: true }).setView([65, 5], 3);
      // Add leaflet map as a new layer
      var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
      }).addTo(map);
      
      // Add polygon drawing control
      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);
      
      var drawControl = new L.Control.Draw({
        draw: {
          polygon: true,
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false,
          circlemarker: false
        },
        edit: {
          featureGroup: drawnItems,
          remove: true,
          edit: false
        }
      });
      map.addControl(drawControl);
      
      // Store markers for filtering
      var eventMarkers = {};
      
      // It even opens up a popup when you click it!
      {% for event in events %}
      var marker{{ loop.index }} = L.marker([{{ event.decimalLatitude }}, {{ event.decimalLongitude }}]).addTo(map);
      marker{{ loop.index }}.bindPopup('<form action="/event_show" method="post"><input type="text" name="eventID" id="eventID" value="{{ event.eventID }}" hidden><button type="submit" name="action1" value="VALUE1">{{ event.eventID }}</button></form>');
      
      // Store marker reference with event data
      eventMarkers["{{ event.eventID }}"] = {
        marker: marker{{ loop.index }},
        latitude: {{ event.decimalLatitude }},
        longitude: {{ event.decimalLongitude }},
        eventID: "{{ event.eventID }}"
      };
      {% endfor %}
      
      // Handle polygon creation
      map.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer;
        drawnItems.addLayer(layer);
        
        // Filter markers based on polygon
        filterMarkersByPolygon(layer);
        
        // Update hidden form field with selected eventIDs
        updatePolygonFilterField(layer);
      });
      
      // Handle polygon deletion
      map.on(L.Draw.Event.DELETED, function (event) {
        // Show all markers when polygon is deleted
        showAllMarkers();
        // Clear the polygon filter field
        clearPolygonFilterField();
      });
      
      // Filter markers based on polygon
      function filterMarkersByPolygon(polygon) {
        var bounds = polygon.getBounds();
        
        // Hide all markers first
        Object.values(eventMarkers).forEach(function(eventData) {
          eventData.marker.removeFrom(map);
        });
        
        // Show only markers within polygon
        Object.values(eventMarkers).forEach(function(eventData) {
          var latlng = L.latLng(eventData.latitude, eventData.longitude);
          if (polygon.getBounds().contains(latlng) && polygon.getLatLngs()[0].some(function(ring) {
            return isMarkerInsidePolygon(latlng, ring);
          })) {
            eventData.marker.addTo(map);
          }
        });
      }
      
      // Show all markers
      function showAllMarkers() {
        Object.values(eventMarkers).forEach(function(eventData) {
          eventData.marker.addTo(map);
        });
      }
      
      // Point in polygon algorithm
      function isMarkerInsidePolygon(latlng, polyPoints) {
        var x = latlng.lat, y = latlng.lng;
        var inside = false;
        for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
          var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
          var xj = polyPoints[j].lat, yj = polyPoints[j].lng;
          
          var intersect = ((yi > y) != (yj > y))
            && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }
      
      // Update hidden form field with selected eventIDs - Bounds-based approach
function updatePolygonFilterField(polygon) {
    var selectedEventIDs = [];
    var bounds = polygon.getBounds();
    
    console.log("Using bounds:", bounds);
    
    Object.values(eventMarkers).forEach(function(eventData) {
        var latlng = L.latLng(eventData.latitude, eventData.longitude);
        
        // Simple bounds check first
        if (bounds.contains(latlng)) {
            selectedEventIDs.push(eventData.eventID);
            console.log("Marker within bounds:", eventData.eventID);
        }
    });
    
    console.log("Selected Event IDs (bounds-based):", selectedEventIDs);
    
    // Update hidden input field
    var hiddenField = document.getElementById('polygon_event_ids');
    if (hiddenField) {
        hiddenField.value = selectedEventIDs.join(',');
        console.log("Hidden field value:", hiddenField.value);
    }
    
    // Show notification
    showPolygonFilterNotification(selectedEventIDs.length);
    }
      
      // Clear the polygon filter field
      function clearPolygonFilterField() {
        $('#polygon_event_ids').val('');
        hidePolygonFilterNotification();
      }
      
      // Show notification about active polygon filter
      function showPolygonFilterNotification(count) {
        var notification = $('#polygonFilterNotification');
        notification.find('.event-count').text(count);
        notification.show();
      }
      
      function hidePolygonFilterNotification() {
        $('#polygonFilterNotification').hide();
      }
      
      // Clear polygon button
      L.easyButton('fa-times', function(btn, map) {
        drawnItems.clearLayers();
        showAllMarkers();
        clearPolygonFilterField();
      }, 'Clear selection').addTo(map);
    </script>
  </div>
  
  <!-- Polygon filter notification -->
  <div id="polygonFilterNotification" class="alert alert-info mt-2" style="display: none;">
    <i class="fa fa-info-circle"></i> 
    Polygon filter active: <span class="event-count">0</span> events selected. 
    Click "Filter" to apply this spatial filter along with other filters.
    <button type="button" class="btn-close float-end" onclick="hidePolygonFilterNotification(); clearPolygonFilterField();"></button>
  </div>
</div>

<!-- METRICS -->
<div id="statContainer" style="display: none;">
  <!-- Events -->
  <h4 style="text-align: center">Events ({{event_len}})</h4>
  <div class="row flex-nowrap overflow-auto">
    <div class="col-4" id="event_year_plot" style="width: 500px;"></div>
    <div class="col-4" id="event_month_plot" style="width: 500px;"></div>
    <div class="col-4" id="event_method_plot" style="width: 500px;"></div>
    <div class="col-4" id="event_habitat1_plot" style="width: 500px;"></div>
    <div class="col-4" id="event_habitat2_plot" style="width: 500px;"></div>
  </div>

  <!-- Specimens -->
  <h4 style="text-align: center">Specimens ({{occ_len}})</h4>
  <div class="row flex-nowrap overflow-auto">
    <div class="col-4" id="occurrence_year_plot" style="width:500px"></div>
    <div class="col-4" id="occurrence_month_plot" style="width:500px"></div>
    <div class="col-4" id="occurrence_method_plot" style="width:500px"></div>
    <div class="col-4" id="occurrence_taxonRank_plot" style="width:500px"></div>
    <div class="col-4" id="occurrence_order_plot" style="width:500px"></div>
    <div class="col-4" id="occurrence_family_plot" style="width:500px"></div>
    <div class="col-4" id="occurrence_genus_plot" style="width:500px"></div>
    <div class="col-4" id="occurrence_habitat1_plot" style="width: 500px;"></div>
    <div class="col-4" id="occurrence_habitat2_plot" style="width: 500px;"></div>
  </div>

  <!-- Taxa -->
  <h4 style="text-align: center">Taxa ({{taxa_len}})</h4>
  <div class="row flex-nowrap overflow-auto">
    <div class="col-4" id="taxa_year_plot" style="width:500px"></div>
    <div class="col-4" id="met_taxon_count_plot" style="width:500px"></div>
    <div class="col-4" id="taxa_taxonRank_plot" style="width:500px"></div>
    <div class="col-4" id="taxa_order_plot" style="width:500px"></div>
    <div class="col-4" id="taxa_family_plot" style="width:500px"></div>
  </div>
</div>


<!-- TABLE -->
<div id="tableContainer" style="display: none;">
  <div class="table-responsive">
    <table class="table table table-hover" id="specimen-table"
      style="white-space: nowrap; font-family: Verdana; font-weight: normal; font-style: normal;">
      <thead>
        <tr style="font-size: smaller;">
          <th><input type="checkbox" id="select-all"></th> <!-- Select all checkboxes in table-->
          <th>Specimen page</th>
          <th>Event page</th>
          <th>Rank</th>
          <th>Taxon</th>
          <th>Sex</th>
          <th>Det.</th>
          <th>Country</th>
          <th>Municipality</th>
          <th>Locality</th>
          <th>Habitat/Substrate</th>
          <th>Eunis habitat</th>
          <th>Date</th>
          <th>Method</th>
          <th>Leg.</th>
          <th>Preparation</th>
          <th>Individual count</th>
        </tr>
      </thead>
      <tbody>
        {% for rank in ranks %}
        {% for occurrence in occurrences %}
        {% if occurrence.taxonRank == rank %}
        <tr>
          <!-- Checkbox 
          <td><input type="checkbox" class="row-checkbox"> </td>-->
          <td>{{occurrence.occurrenceID}}</td>
          <!-- Specimen -->
          <td><a class="btn btn-outline-dark btn-sm"
              href="{{ url_for('specimens.specimen_view', occurrence_id=occurrence.occurrenceID) }}" role="button"
              style="width: 120px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis; {% if occurrence.sequenceID %} background-color: darkgreen;color: white; {% endif %}">{{occurrence.occurrenceID}}</a>
          </td>
          <!-- Event-ID -->
          <td>
            <form action="/event_show" method="post">
              <input type="text" name="eventID" id="eventID" value="{{ occurrence.eventID }}" hidden>
              <button type="submit" class="btn btn-outline-dark btn-sm" name="action1" value="VALUE1"
                style="width: 120px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">{{
                occurrence.eventID }}</button>
            </form>
          </td>
          <!-- Taxon rank -->
          <td>{{ occurrence.taxonRank }}</td>
          <!-- Taxon -->
          <td>{{ occurrence.scientificName | italicize_scientific_name | safe }} {% if
            occurrence.identificationQualifier %},
            {{occurrence.identificationQualifier}}{% endif %}</td>
          <!-- Sex -->
          <td>{{ occurrence.sex | if_present }}</td>
          <!-- Identified by -->
          <td>{{ occurrence.identifiedBy }}, {{ occurrence.dateIdentified | string_to_date |
            date_format("%B
            %Y") }}</td>
          <!-- Country -->
          <td>{{ occurrence.country | if_present }}</td>
          <!-- Municipality -->
          <td>{{ occurrence.municipality | if_present }}</td>
          <!-- Locality -->
          <td>{{ occurrence.locality_1 | locality_format(occurrence.locality_2) }}</td>
          <!-- Habitat -->
          <td>
            {% if occurrence.substrateName %}
            {{ occurrence.substrateName|format_substrate (occurrence.substratePlantPart, occurrence.substrateType) |
            safe }}
            {% elif occurrence.habitat %}
            {{ occurrence.habitat }}
            {% endif %}
          </td>
          <!-- Eunis habitat -->
          <td>{{ occurrence.habitatName | format_eunis(occurrence.eunisCode) }}</td>
          <!-- Date -->
          <td>{{ occurrence.eventDate_1 | format_dates(occurrence.eventDate_2) | striptags }}</td>
          <!-- Method -->
          <td>{{ occurrence.samplingProtocol | if_present }}</td>
          <!-- Collected by -->
          <td>{{ occurrence.recordedBy | leg_format | if_present | safe }}</td>
          <!-- Preparation -->
          <td>{{ occurrence.preparations | if_present | safe }}</td>
          <!-- Individual count -->
          <td>{{ occurrence.individualCount | if_present | safe }}</td>
        </tr>
        {% endif %}
        {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- trailing space -->
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>

<script>
  // METRICS
  // Plot function with Plotly
  function myBarplot(myplot, orient, type, title, yArray, xArray) {
    let data
    let layout
    if (type == "pie") {
      data = [{ labels: xArray, values: yArray, type: type, orientation: orient, marker: { color: "rgba(0,0,255,0.6)" }, textinfo: 'none' }];
      layout = { 
        title: title, 
        showlegend: false
      };
    } else {
      data = [{ x: xArray, y: yArray, type: type, orientation: orient, marker: { color: "rgba(0,0,255,0.6)" } }];
      layout = { 
        title: title, 
        showlegend: false,
        xaxis: {
            dtick: 1 // Do not use decimals on x axis
        }
      };
    }
    return Plotly.newPlot(myplot, data, layout, { displayModeBar: false });
  }
  // Call the barplot function for each plot
  // Collecting-event plots
  myBarplot("event_year_plot", "v", "bar", "Year", {{ event_year["count"] }}, {{ event_year["label"] | safe }})
  myBarplot("event_month_plot", "v", "bar", "Month", {{ event_month["count"] }}, {{ event_month["label"] | safe }})
  myBarplot("event_method_plot", "v", "bar", "Method", {{ event_method["count"] }}, {{ event_method["label"] | safe }})
  myBarplot("event_habitat1_plot", "v", "bar", "Habitat (level 1)", {{ event_habitat1["count"] }}, {{ event_habitat1["label"] | safe }})
  myBarplot("event_habitat2_plot", "v", "pie", "Habitat (level-2)", {{ event_habitat2["count"] }}, {{ event_habitat2["label"] | safe }})
  // Occurrence plots
  myBarplot("occurrence_year_plot", "v", "bar", "Year", {{ occurrence_year["count"] }}, {{ occurrence_year["label"] | safe }})
  myBarplot("occurrence_month_plot", "v", "bar", "Month", {{ occurrence_month["count"] }}, {{ occurrence_month["label"] | safe }})
  myBarplot("occurrence_method_plot", "v", "bar", "Method", {{ occurrence_method["count"] }}, {{ occurrence_method["label"] | safe }})
  myBarplot("occurrence_habitat1_plot", "v", "bar", "Habitat (level 1)", {{ occurrence_habitat1["count"] }}, {{ occurrence_habitat1["label"] | safe }})
  myBarplot("occurrence_habitat2_plot", "v", "pie", "Habitat (level-2)", {{ occurrence_habitat2["count"] }}, {{ occurrence_habitat2["label"] | safe }})
  myBarplot("occurrence_order_plot", "v", "bar", "Order", {{ occurrence_order["count"] }}, {{ occurrence_order["label"] | safe }})
  myBarplot("occurrence_family_plot", "v", "pie", "Family", {{ occurrence_family["count"] }}, {{ occurrence_family["label"] | safe }})
  myBarplot("occurrence_genus_plot", "v", "pie", "Genus", {{ occurrence_genus["count"] }}, {{ occurrence_genus["label"] | safe }})
  myBarplot("occurrence_taxonRank_plot", "v", "bar", "Identification level", {{ occurrence_taxonRank["count"] }}, {{ occurrence_taxonRank["label"] | safe }})
  // Taxa plots
  myBarplot("taxa_year_plot", "v", "bar", "Year", {{ taxa_year["count"] }}, {{ taxa_year["label"] | safe }})
  myBarplot("met_taxon_count_plot", "v", "bar", "Method", {{ met_taxon_count["count"] }}, {{ met_taxon_count["label"] | safe }})
  myBarplot("taxa_taxonRank_plot", "v", "bar", "Identification level", {{ taxa_taxonRank["count"] }}, {{ taxa_taxonRank["label"] | safe }})
  myBarplot("taxa_family_plot", "v", "pie", "Family", {{ taxa_family["count"] }}, {{ taxa_family["label"] | safe }})
  myBarplot("taxa_order_plot", "v", "bar", "Order", {{ taxa_order["count"] }}, {{ taxa_order["label"] | safe }})

  // CHECKBOXES
  // Function to select all checkboxes by clicking the header checkbox
  $(document).ready(function () {
    // Initiate the datatable. The first row of the table is not searchable or orderable, and is a checkbox
    var table = $('#specimen-table').DataTable({
      'columnDefs': [{
        'targets': 0,
        'searchable': false,
        'orderable': false,
        'className': 'dt-body-center',
        'render': function (data, type, full, meta) {
          return '<input type="checkbox" class="row-checkbox" value="' + full[0] + '">'; // full[0] is the first column of the table, it includes the occurrenceID
        }
      }],
      'order': [[1, 'asc']]
    });

    var checkboxStates = {};

    // Handle the select-all checkbox
    $('#select-all').on('click', function () {
      var rows = table.rows({ 'search': 'applied' }).nodes();
      $('input[type="checkbox"]', rows).prop('checked', this.checked);
      var isChecked = this.checked;
      table.rows({ 'search': 'applied' }).every(function () {
        var data = this.data();
        var id = data[0]; // The unique Occurrence-ID is in the first index
        checkboxStates[id] = isChecked;
      });
    });

    // Handle checkbox change and update state object
    $('#specimen-table tbody').on('change', 'input[type="checkbox"]', function () {
      var row = $(this).closest('tr');
      var data = table.row(row).data();
      var id = data[0]; // The unique Occurrence-ID is in the first index
      checkboxStates[id] = this.checked;
    });

    // Function to collect data from selected checkboxes
    function getSelectedCheckboxValues() {
      var selected = [];
      for (var id in checkboxStates) {
        if (checkboxStates[id]) {
          selected.push(id);
        }
      }
      return selected;
    };

    // Export faunistic report
    $('#exportFaunistic').on('click', function (e) {
      e.preventDefault(); // Prevent default action of the link
      var selectedValues = getSelectedCheckboxValues();
      // alert if no checkboxes are checked
      if (selectedValues.length === 0) {
        alert("Please select at least one specimen to export.");
        return;
      }
      // Construct the URL with the selected IDs, separated by "|"
      var url = '/export_faunistic_report?specimen_ids=' + selectedValues.join('|');
      // Update the href and trigger the click
      $(this).attr('href', url);
      window.open(url, '_blank'); // Open the link in a new tab
    });

    // Export GBIF table
    $('#exportGBIF').on('click', function (e) {
      e.preventDefault(); // Prevent default action of the link
      var selectedValues = getSelectedCheckboxValues();
      // alert if no checkboxes are checked
      if (selectedValues.length === 0) {
        alert("Please select at least one specimen to export.");
        return;
      }
      // Construct the URL with the selected IDs, separated by "|"
      var url = '/export_GBIF?specimen_ids=' + selectedValues.join('|');
      // Update the href and trigger the click
      $(this).attr('href', url);
      window.open(url, '_blank'); // Open the link in a new tab
    });

    // Export DNA barcodes 
    $('#exportDnaBarcodes').on('click', function (e) {
      e.preventDefault(); // Prevent default action of the link
      var selectedValues = getSelectedCheckboxValues();
      // alert if no checkboxes are checked
      if (selectedValues.length === 0) {
        alert("Please select at least one specimen to export.");
        return;
      }
      // Construct the URL with the selected IDs, separated by "|"
      var url = '/export_DNA_barcodes?specimen_ids=' + selectedValues.join('|');
      // Update the href and trigger the click
      $(this).attr('href', url);
      window.open(url, '_blank'); // Open the link in a new tab
    });

    // Export collecting-event table 
    $('#exportEvents').on('click', function (e) {
      e.preventDefault(); // Prevent default action of the link
      var events = {{ event_ids | tojson }};
      // alert if no checkboxes are checked
      if (events.length === 0) {
        alert("Please select at least one event.");
        return;
      }
      // Construct the URL with the selected IDs, separated by ";"
      var url = '/export_events/' + events.join('|');
      // Update the href and trigger the click
      $(this).attr('href', url);
      window.open(url, '_blank'); // Open the link in a new tab
    });

  // Send values to be added to dataset
  $('#add_to_dataset').on('click', function () {
    var datasetName = $('#dataset').val();
    var selectedValues = getSelectedCheckboxValues();
    // AJAX request to send data to the server
    $.ajax({
      url: '/add_to_dataset', // The URL to the server
      type: 'POST', // Use POST method for sending data
      data: JSON.stringify({ ids: selectedValues, datasetName: datasetName }), // Send selectedValues as JSON
      contentType: 'application/json', // Content type must be set to application/json
      success: function (response) {
        // Set the text of the span inside the alert
        $('#messageContent').text(response.message);
        // Show the alert by adding 'show' class and removing 'hide'
        $('#responseMessage').addClass('show').removeClass('hide');
      },
      error: function (xhr, status, error) {
        // Set error text and show the alert
        $('#messageContent').text('Error: ' + error);
        $('#responseMessage').addClass('show').removeClass('hide');
      }
    });
  });
  // Send values to be removed from dataset
  $('#remove_from_dataset').on('click', function () {
    var datasetName = $('#dataset').val();
    var selectedValues = getSelectedCheckboxValues();
    // AJAX request to send data to the server
    $.ajax({
      url: '/remove_from_dataset', // The URL to the server
      type: 'POST', // Use POST method for sending data
      data: JSON.stringify({ ids: selectedValues, datasetName: datasetName }), // Send selectedValues as JSON
      contentType: 'application/json', // Content type must be set to application/json
      success: function (response) {
        // Set the text of the span inside the alert
        $('#messageContent').text(response.message);
        // Show the alert by adding 'show' class and removing 'hide'
        $('#responseMessage').addClass('show').removeClass('hide');
      },
      error: function (xhr, status, error) {
        // Set error text and show the alert
        $('#messageContent').text('Error: ' + error);
        $('#responseMessage').addClass('show').removeClass('hide');
      }
    });
  });
  
  });


</script>

{% endblock %}