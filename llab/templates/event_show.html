{% extends "base.html" %}
{% block content %}

<style>
    th.tablespace {
        padding-top: 15px
    }

    .observation-gallery-container {
        margin: 1.5rem 0;
    }

    .observation-gallery {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        scroll-snap-type: x proximity;
        padding-bottom: 1rem;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    
    .gallery-item {
        flex: 0 0 auto;
        scroll-snap-align: start;
        width: 500px; /* Fixed width or use min-width/max-width */
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        background: white;
    }
    
    .gallery-item img {
        width: 100%;
        height: 400px;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .gallery-item img:hover {
        transform: scale(1.02);
    }
    
    .image-caption {
        padding: 0.5rem;
        margin: 0;
        font-size: 0.9rem;
        color: #555;
        text-align: center;
    }
    
    /* Hide scrollbar but keep functionality */
    .observation-gallery::-webkit-scrollbar {
        display: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .gallery-item {
            width: 400px;
        }
        .gallery-item img {
            height: 350px;
        }
    }
    
</style>

<form action="/event_show" method=post>

    Select collecting event
    <div class="mb-3">
        <select class="form-control selectpicker" id="eventID" name="eventID" data-live-search="true">
            {% for i in events %}
            {% if i.eventID == event.eventID %}
            <option selected value="{{ i.eventID }}">{{ i.eventID }} {% if i.municipality %}- {{ i.municipality }}{% endif %} {%
                if i.locality_1 %}- {{ i.locality_1 }}{% endif %} {% if i.locality_2 %}- {{ i.locality_2 }}{% endif %}
            </option>
            {% else %}
            <option value="{{ i.eventID }}">{{ i.eventID }} {% if i.municipality %}- {{ i.municipality }}{% endif %} {%
                if i.locality_1 %}- {{ i.locality_1 }}{% endif %} {% if i.locality_2 %}- {{ i.locality_2 }}{% endif %}
            </option>
            {% endif %}
            {% endfor %}
        </select>
    </div>

    <!-- Button 1-->
    <div class="d-inline mb-3">
        <button type="submit" class="btn btn-success btn-lg" name="action1" value="VALUE1">Show</button>
        <!-- Button 2-->
        <button type="submit" class="btn btn-secondary btn-lg" name="action2" value="VALUE2">Edit</button>
    </div>
</form>
<br />

{% if event %}

<br />

<!-- Leaflet -->
<div id="map" style="height: 250px;"></div>
<script type="text/javascript">
    // The first parameters are the coordinates of the center of the map, the second parameter is the zoom level
    var map = L.map('map', {fullscreenControl: true}).setView([{{ event.decimalLatitude }}, {{ event.decimalLongitude }}], 11);
    // Add leaflet map as a new layer
    var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    }).addTo(map);
    // It even opens up a popup when you click it!
    L.marker([{{ event.decimalLatitude }}, {{ event.decimalLongitude }}]).addTo(map)
</script>
<br />

<!-- Display event data in responsive table -->
<div class="table-responsive">
    <table class="table table-sm" style="white-space: nowrap; font-family: Verdana; font-weight: normal; font-style: normal;">
    <!-- Table header -->
    <tr class="border-bottom border-dark align-bottom">
        <th>{{ event.eventID }}{% if event.locality_1 %} - {{ event.locality_1 }}{% endif %}{% if event.locality_2 %} - {{ event.locality_2 }}{% endif %}:</th>
        <th></th>
    </tr>
    <!-- Protocol -->
    {{ event.samplingProtocol | tablerow("Method") | safe }}
    <!-- Date -->
    {{ event.eventDate_1 | format_dates(event.eventDate_2) | striptags | tablerow("Date") | safe }}
    <!-- Habitat -->
    {{ event.habitat | tablerow("Habitat") | safe }}
    <!-- EUNIS Habitat -->
    {% for habitat in habitats %} 
    {% if habitat.eunisCode == event.eunisCode %}
    {{ habitat.habitatName | format_eunis (event.eunisCode) | tablerow("Eunis habitat") | safe }}
    {% endif %}
    {% endfor %}
    <!-- Substrate -->
    {{ event.substrateName | format_substrate(event.substratePlantPart, event.substrateType) | tablerow("Substrate") | safe }}
    <!-- Recorded by -->
    {{ event.recordedBy | tablerow("Recorded by") | safe }}
    <!-- Remarks -->
    {{ event.eventRemarks | tablerow("Remarks") | safe }}

    <tr class="border-bottom border-dark align-bottom">
        <th>Locality:</th>
        <th></th>
    </tr>
    <!-- Country -->
    {{ event.countryCode | tablerow("Country") | safe }}
    <!-- County -->
    {{ event.county | tablerow("County") | safe }}
    <!-- Municipality -->
    {{ event.municipality | tablerow("Municipality") | safe }}
    <!-- Locality name -->
    {{ event.locality_1 | locality_format(event.locality_2) | tablerow("Locality name") | safe }}
    <!-- Coordinates -->
    <tr>
        <td>Coordinates</td>
        <td><a href="http://maps.google.com/maps?q={{ event.decimalLatitude }},{{ event.decimalLongitude }}">{{ event.decimalLatitude }}, {{ event.decimalLongitude }}</a></td>
    </tr>
    <!-- Coordinate uncertainty (m) -->
    {{ event.coordinateUncertaintyInMeters | tablerow("Coordinate uncertainty (m)") | safe }}

</table>
</div>

<br />

<p></p>

<!-- Show images -->
<div class="observation-gallery-container">
    <div class="observation-gallery">
      <!-- Dynamic images from your backend -->
      {% for file in files %}
      <div class="gallery-item">
        <img src="static/images/compressed/{{file.filename}}" alt="Observation photo {{ loop.index }}" loading="lazy" onclick="window.open(window.location.origin+'/static/images/events/{{file.filename}}', '_blank');">
        <p class="image-caption">{{ file.comment or '' }}</p>
      </div>
      {% endfor %}
    </div>
</div>

<form action="/" method=post>

<!-- Button 3-->
<div class="mb-3" style="padding-bottom: 20px;">
    <input type="text" name="eventID" id="eventID" value="{{ event.eventID }}" hidden>
    <button type="submit" class="btn btn-secondary btn-sm" name="collecting_event_id" value="collecting_event_id">View specimens</button>
</div>
</form>

<!-- trailing area -->
<p></p>
<p></p>
<p> </p>

<script>
    document.querySelectorAll('.observation-gallery').forEach(gallery => {
      let isDown = false;
      let startX;
      let scrollLeft;
    
      gallery.addEventListener('mousedown', (e) => {
        isDown = true;
        startX = e.pageX - gallery.offsetLeft;
        scrollLeft = gallery.scrollLeft;
        gallery.style.cursor = 'grabbing';
      });
    
      gallery.addEventListener('mouseleave', () => {
        isDown = false;
        gallery.style.cursor = 'grab';
      });
    
      gallery.addEventListener('mouseup', () => {
        isDown = false;
        gallery.style.cursor = 'grab';
      });
    
      gallery.addEventListener('mousemove', (e) => {
        if(!isDown) return;
        e.preventDefault();
        const x = e.pageX - gallery.offsetLeft;
        const walk = (x - startX) * 2; // Adjust scroll speed
        gallery.scrollLeft = scrollLeft - walk;
      });
    });
    </script>
    

{% endif %}

{% endblock %}