{% extends "base.html" %}
{% block content %}
<!-- Form -->
<form action="/observation_add" method="POST" enctype="multipart/form-data">

    <!-- Scientific name -->
    <div class="mb-3">
        Scientific name
        <select class="form-control selectpicker" id="taxonInt" name="taxonInt" data-live-search="true">
            {% for i in taxa %}
            <option value="{{i.taxonInt}}">{{i.scientificName}}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Images -->
    <div class="mb-3">
        <label for="files">Select images</label>
        <input type="file" id="files" multiple="multiple" accept="image/jpeg, image/png, image/jpg"
            class="form-control" name="files" onchange="loadFiles(event)">
        <div class="img_container" id="result"></div>
    </div>
    <br>

    <div class="card" id="card1" onclick="image_coordinates()">
        <div class="card-header">
            Image coordinates and time
        </div>
        <div class="card-body">
            <!-- Image data: Coordinates and date -->
            <div class="row">
                <div class="col mb-1">
                    <label for="uncertainty">Latitude</label>
                    <input type="text" class="form-control" id="Latitude" name="Latitude">
                </div>
                <div class="col mb-1">
                    <label for="uncertainty">Longitude</label>
                    <input type="text" class="form-control" id="Longitude" name="Longitude" >
                </div>
                <div class="col mb-3">
                    <label for="uncertainty">Uncertainty (m)</label>
                    <input type="text" class="form-control" id="uncertaintyInMeters" name="uncertaintyInMeters" value=10>
                </div>
            </div>
            <div class="row">
                <div class="col mb-1">
                    <label for="date">Date</label>
                    <input type="date" class="form-control" id="date" name="date">
                </div>
                <div class="col mb-1">
                    <label for="time">Time</label>
                    <input type="time" class="form-control" id="time" name="time">
                </div>
            </div>
        </div>
    </div>

    <br>

    <div class="card" id="card2" onclick="stedsnavn_call()">
        <div class="card-header">
            Location
        </div>
        <div class="card-body">
            <!-- Country code -->
            <div class="mb-1">
                <select class="form-control selectpicker" id="Country" name="Country" data-live-search="true">
                    {% for country in countries %}
                    {% if country.countryCode == "NO" %}
                    <option selected value="{{ country.countryCode }}">{{ country.country }}</option>
                    {% else %}
                    <option value="{{ country.countryCode }}">{{ country.country }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <!-- County -->
            <div class="mb-1">
                <input type="text" class="form-control" id="County" aria-describedby="County" placeholder="County"
                    name="County">
            </div>

            <!-- Municipality -->
            <div class="mb-1">
                <input type="text" class="form-control" id="Municipality" aria-describedby="Municipality"
                    placeholder="Municipality" name="Municipality">
            </div>

            <!-- Locality -->
            <div class="mb-3">
                <input type="text" class="form-control" id="Locality_2" aria-describedby="Locality_2"
                    placeholder="Locality" name="Locality_2">
            </div>
        </div>
    </div>
    <br>

    <!-- Collapsible input -->
    <div class="card">
        <!-- Collapse button -->
        <div class="card-header">
            <a class="btn" data-bs-toggle="collapse" href="#collapseInput">
                Additional input
            </a>
        </div>
        <!-- Collapsible area -->
        <div id="collapseInput" class="collapse">
            <div class="card-body">
                <!-- Recorded by -->
                Recorded by
                <div class="mb-3">
                    <select class="form-select" id="recordedBy" name="recordedBy">
                        {% for name in entomologists %}
                        {% if name.recordedBy == user.entomologist_name %}
                        <option selected value="{{name.recordedBy}}">{{name.recordedBy}}</option>
                        {% else %}
                        <option value="{{name.recordedBy}}">{{name.recordedBy}}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <!-- lifestage -->
                Lifestage
                <div class="mb-3">
                    <select class="form-select" name="lifeStage" id="lifeStage">
                        <option selected value="adult">adult</option>
                        <option value="nymph">nymph</option>
                        <option value="pupa">pupa</option>
                        <option value="larva">larva</option>
                    </select>
                </div>

                <!-- Individual count -->
                Individual count
                <div class="mb-3">
                    <input type="number" class="form-control" id="individualCount" name="individualCount" min="1"
                        value="1">
                </div>

                <!-- Sex -->
                Sex
                <div class="mb-3">
                    <select class="form-select" name="sex" id="sex">
                        <option selected value=""></option>
                        <option value="female">female</option>
                        <option value="male">male</option>
                    </select>
                </div>

                <!-- occurrenceRemarks -->
                Occurrence remarks
                <div class="mb-3">
                    <input type="text" class="form-control" id="occurrenceRemarks" name="occurrenceRemarks">
                </div>
            </div>
        </div>
    </div>
    <br>

    <div class="mb-3">
        <!-- Button 2-->
        <button type="submit" class="btn btn-lg btn-success" name="action1" value="VALUE1">Submit</button>
    </div>
</form>
<br>


<script>
    // Function to load selected files
    function loadFiles(event) {
        const files = event.target.files;
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = ''; // Clear previous results

        Array.from(files).forEach(file => {
            const reader = new FileReader();

            reader.onload = function (e) {
                // Create an img element
                const img = new Image();
                img.src = e.target.result;
                img.style.maxWidth = '300px'; // Adjust image size for display

                // Add the image to the container
                resultDiv.appendChild(img);
            };

            // Read the image file as a data URL
            reader.readAsDataURL(file);
        });
    }

    // Function to extract EXIF data from the first image in the container
    function image_coordinates() {
        const img = document.querySelector("#result img"); // Get the first image from the result container

        if (img) {
            EXIF.getData(img, function () {
                const lat = EXIF.getTag(this, 'GPSLatitude');
                const lon = EXIF.getTag(this, 'GPSLongitude');
                const eventDateTime = EXIF.getTag(this, 'DateTimeOriginal');

                const latRef = EXIF.getTag(this, 'GPSLatitudeRef') || "N";
                const lonRef = EXIF.getTag(this, 'GPSLongitudeRef') || "W";
                const latitude = convertDMSToDD(lat, latRef);
                const longitude = convertDMSToDD(lon, lonRef);

                // Split eventDateTime
                const date = eventDateTime.split(" ")[0];
                const date2 = date.split(":")[0]+"-"+date.split(":")[1]+"-"+date.split(":")[2];
                const time = eventDateTime.split(" ")[1];
                const time2 = time.split(":")[0]+":"+time.split(":")[1]+":00";

                console.log("time2")

                // Set hidden form inputs
                document.getElementById('Latitude').value = latitude || '';
                document.getElementById('Longitude').value = longitude || '';
                document.getElementById('date').value = date2 || '';
                document.getElementById('time').value = time2 || '';

            });
        } else {
            console.log('No image found in the container.');
        }
    }

    // Function to convert DMS (degrees, minutes, seconds) to decimal degrees
    function convertDMSToDD(dms, ref) {
        if (!dms) return null;

        const degrees = dms[0];
        const minutes = dms[1];
        const seconds = dms[2];
        let dd = degrees + (minutes / 60) + (seconds / 3600);

        // If the reference is South or West, make the coordinates negative
        if (ref === "S" || ref === "W") {
            dd = dd * -1;
        }

        return dd;
    }
</script>

{% endblock %}