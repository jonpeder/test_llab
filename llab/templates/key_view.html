{% extends "base.html" %}
{% block content %}

<style>
    th.tablespace {
        padding-top: 15px
    }

    .key-gallery-container {
        margin: 1.5rem 0;
    }

    .key-gallery {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        scroll-snap-type: x proximity;
        padding-bottom: 1rem;
        -webkit-overflow-scrolling: touch;
        /* Smooth scrolling on iOS */
    }

    .gallery-item {
        flex: 0 0 auto;
        scroll-snap-align: start;
        width: 350px;
        /* Fixed width or use min-width/max-width */
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        background: white;
    }

    .gallery-item img {
        width: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .gallery-item img:hover {
        transform: scale(1.02);
    }

    .image-caption {
        padding: 0.5rem;
        margin: 0;
        font-size: 0.9rem;
        color: #555;
        text-align: center;
    }

    /* Hide scrollbar but keep functionality */
    .observation-gallery::-webkit-scrollbar {
        display: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .gallery-item {
            width: 300px;
        }
    }
</style>

<form action="/key_view" method="post">
    <!-- Select identification key -->
    Select identification key
    <div class="mb-3">
        <select class="form-control selectpicker" id="identification_key" name="identification_key"
            data-live-search="true" required>
            <option value=""></option>
            {% for key in keys %}
            <option value="{{ key.id }}" {% if key_id and key.id==key_id|int %}selected{% endif %}>{{ key.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Buttons -->
    <div class="d-inline mb-3">
        <!-- Button 1-->
        <button type="submit" class="btn btn-success btn-lg" name="action1" value="VALUE1">View</button>
        <!-- Button 2-->
        <button type="submit" class="btn btn-secondary btn-lg" name="action2" value="VALUE2">Edit</button>
    </div>
</form>
<br />

{% if current_step or reached_conclusion %}
<div class="row">
    <!-- Key Steps Column -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>
                    {% for key in keys %}
                    {% if key.id==key_id|int %}{{ key.name }}{% endif %}
                    {% endfor %}
                </h5>
            </div>
            <div class="card-body">
                {% if reached_conclusion %}
                <!-- Conclusion Message (in left column) -->
                <div class="card border-success">
                    <div class="card-body">
                        <h5 class="display-8">{{ conclusion_name | italicize_scientific_name | safe }}</h5>
                        <!-- Image gallery -->
                        {% if conclusion_figures %}
                        <div class="key-gallery-container">
                            <div class="key-gallery">
                                {% set figures_data = get_figures_for_display(conclusion_figures) %}
                                {% for fig in figures_data %}
                                <!-- Dynamic images -->
                                <div class="gallery-item">
                                    <img src="/static/images/compressed/{{ fig.filename }}" loading="lazy"
                                        onclick="window.open(window.location.origin+'/static/images/illustrations/{{fig.filename}}', '_blank');">
                                    <p class="image-caption" style="font-size: x-small;"><strong>Fig. {{
                                            fig.figure_number }}:</strong> {{ fig.figure_text | safe }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <!-- Current Step Options -->
                <div class="row">
                    {% for option in current_step %}
                    <div class="col-md-6 mb-2">
                        <div class="card option-card {% if not option.question %}bg-light{% endif %}">
                            <div class="card-body">
                                <!-- If question -->
                                {% if option.question %}
                                <!-- Option button -->
                                <a href="{{ url_for('keys.key_view', step_id=option.id, key_id=key_id) }}"
                                    class="btn btn-outline-primary btn-sm">
                                    {% if option.taxonID %}
                                    {% for taxon in taxa %}
                                    {% if taxon.taxonInt == option.taxonID %}
                                    {{ taxon.scientificName | italicize_scientific_name | safe }}
                                    {% endif %}
                                    {% endfor %}
                                    {% elif option.name | int > 0 %}
                                    >>
                                    {% else %}
                                    {{ option.name | italicize_scientific_name | safe }}
                                    {% endif %}
                                </a>
                                <p></p>
                                <!-- Question -->
                                <p class="card-text">{{ option.question }}</p>
                                <!-- Comment -->
                                {% endif %}
                                {% if option.comment %}
                                <div class="card-text text-muted">
                                    {{ option.comment }}
                                </div>
                                {% endif %}
                                <!-- Image gallery -->
                                {% if option.figures %}
                                <div class="key-gallery-container">
                                    <div class="key-gallery">
                                        {% set figures_data = get_figures_for_display(option.figures) %}
                                        {% for fig in figures_data %}
                                        <!-- Dynamic images -->
                                        <div class="gallery-item">
                                            <img src="/static/images/compressed/{{ fig.filename }}" loading="lazy"
                                                onclick="window.open(window.location.origin+'/static/images/illustrations/{{fig.filename}}', '_blank');">
                                            <p class="image-caption" style="font-size: x-small;"><strong>Fig. {{
                                                    fig.figure_number }}:</strong> {{ fig.figure_text | safe }}</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>


    <!-- Right Column -->
    <div class="col-md-4">
        <!-- Remaining names -->
        <div class="card">
            <div class="card-header">
                <h5>Remaining Taxa</h5>
                <small class="text-muted">
                    {% if reached_conclusion %}
                    1 identified taxon
                    {% else %}
                    {{ possible_names|length }} remaining taxa
                    {% endif %}
                </small>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% if reached_conclusion %}
                    <li class="list-group-item">
                        {{ conclusion_name | italicize_scientific_name | safe }}
                    </li>
                    {% elif possible_names %}
                    {% for name in possible_names %}
                    <li class="list-group-item">
                        {{ name | italicize_scientific_name | safe }}
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list-group-item">
                        No names available!
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        <br>

        <!-- Key desctiption -->
        <div class="card">
            <div class="card-header">
                <h5>Key desctiption</h5>
            </div>
            <div class="card-body">
                {% for key in keys %}
                {% if key.id==key_id|int %}{{ key.description }}{% endif %}
                {% endfor %}
            </div>
        </div>
        <br>

        <!-- Key desctiption -->
        <div class="card">
            <div class="card-header">
                <h5>References</h5>
            </div>
            <div class="card-body">
                {% for key in keys %}
                {% if key.id==key_id|int %}{{ key.bibliographicReference }}{% endif %}
                {% endfor %}
            </div>
        </div>

    </div>




</div>
{% endif %}

{% endblock %}